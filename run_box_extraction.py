import numpy as np
import math

from colabsnippets.face_detection.yolov2 import (
  create_gt_mask,
  create_gt_coords,
  reconstruct_box
)

anchors = [
  (1.603231, 2.094468),
  (6.041143, 7.080126),
  (2.882459, 3.518061),
  (4.266906, 5.178857),
  (9.041765, 10.66308)
]
boxes = [
  [0.42788461538461536, 0.3173076923076923, 0.03365384615384615, 0.040865384615384616],
  [0.08653846153846154, 0.3293269230769231, 0.052884615384615384, 0.0625],
  [0.004807692307692308, 0.3293269230769231, 0.03125, 0.03365384615384615],
  [0.2932692307692308, 0.3004807692307692, 0.04567307692307692, 0.05048076923076923],
  [0.21634615384615385, 0.2932692307692308, 0.03365384615384615, 0.04567307692307692],
  [0.8918269230769231, 0.4014423076923077, 0.07932692307692307, 0.10096153846153846],
  [0.7716346153846154, 0.3173076923076923, 0.02403846153846154, 0.03365384615384615],
  [0.5697115384615384, 0.28846153846153844, 0.040865384615384616, 0.04567307692307692],
  [0.5240384615384616, 0.3076923076923077, 0.03365384615384615, 0.040865384615384616],
  [-0.10788461538461536, 0.3173076923076923, 0.33365384615384615, 0.040865384615384616],
  [0.80788461538461536, 0.3173076923076923, 0.33365384615384615, 0.040865384615384616],
  [-0.1, 0.3173076923076923, 0.1, 0.040865384615384616]
]

num_cells = 13
is_apply_sigmoid = True
for box in boxes:
  gt_mask = create_gt_mask([[box]], num_cells, anchors)
  gt_coords = create_gt_coords([[box]], num_cells, anchors, is_apply_inverse_sigmoid=is_apply_sigmoid)

  cols, rows, anchor_idxs = np.where(gt_mask != 0)[1:4]
  col, row, anchor_idx = cols[0], rows[0], anchor_idxs[0]
  print('anchor_idx', anchor_idx)

  gt = gt_coords[0][col][row][anchor_idx]

  print(box)
  print(reconstruct_box(gt, col, row, anchors[anchor_idx], num_cells, is_apply_sigmoid=is_apply_sigmoid))